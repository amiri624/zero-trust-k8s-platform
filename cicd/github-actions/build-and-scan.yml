
name: Build, Scan & Push Demo App

on:
  push:
    paths:
      - 'k8s/demo-app/**'
      - '.github/**'
      - 'Dockerfile'
    branches: [ "main" ]

jobs:
  build-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU and Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_TOKEN }}

      - name: Build Docker image
        run: |
          IMAGE=${{ secrets.REGISTRY_URL }}/demo-app:${{ github.sha }}
          docker build -t $IMAGE -f k8s/demo-app/Dockerfile k8s/demo-app
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@v0.5.0
        with:
          image-ref: ${{ env.IMAGE }}

      - name: Push image
        run: docker push ${{ env.IMAGE }}

      - name: Create image manifest file
        run: echo "${{ env.IMAGE }}" > image.txt

      - name: Upload image info
        uses: actions/upload-artifact@v4
        with:
          name: image-info
          path: image.txt
YAML

Secrets needed in repo settings:

REGISTRY_URL (e.g., ghcr.io/yourorg or DockerHub)

REGISTRY_USER

REGISTRY_TOKEN
